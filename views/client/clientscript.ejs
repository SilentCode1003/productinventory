<script>
    $(document).ready(function () {
      let id = "";
      let name = "";
      let status = "";
  
      LoadTable();
  
      $("#datatable tbody").on("click", "tr", function () {
        var dataRow = [];
        $(this)
          .closest("tr")
          .find("td")
          .each(function () {
            dataRow.push($(this).text());
          });
        console.log(dataRow);
        id = dataRow[0];
        name = dataRow[1];
        status = dataRow[2];
      });
  
      $(document).on("click", "#editBtn", function () {
        $("#idmodal").val(id);
        $("#namemodal").val(name);
        $("#editModal").modal("show");
        console.log("Client: " + id);
      });
  
      $(document).on("click", "#addBtn", function () {
        let companyname = $("#companyname").val();
        let branchname = $("#branchname").val();
  
        let message = "";
  
        if (branchname == "") {
          message += "Branch Name, ";
        }
        if(branchname == "") {
          message += "Company Name";
        }
        if (message != "") {
          warning("Required", `Please fill up ${message}`);
        } 
        else {
          $.ajax({
            type: "POST",
            url: "/client/save",
            data: {
              company: companyname,
              branch: branchname,
            },
            success: function (result) {
              if (result.msg == "success") {
                LoadTable();
                success("Saved", "Successfully");
                $("#companyname").val('');
                $("#branchname").val('');
              }
  
              if (result.msg == "exist") {
                warning("Exist", `${name} has already registered!`);
              }
            },
            error: function (err) {
              errormsg(err);
            },
          });
        }
      });
  
      //Edit Update
      $(document).on("click", "#updateBtn", function () {
        let idmodal = $("#idmodal").val();
        let branchmodal = $("#branchmodal").val();
        let companymodal = $("#companymodal").val();
  
        var message = "";
  
        if (branchmodal == "" && companymodal == "") {
          message += "Fill up atleast 1 input field before updating!";
        }
  
        if (message != "") {
          warning("Required", `Please fill up ${message}`);
        } else {
          $.ajax({
            type: "POST",
            url: "/client/edit",
            data: {
              company: companymodal,
              branch: branchmodal,
              id: idmodal,
            },
            success: function (result) {
              if (result.msg == "success") {
                LoadTable();
                success("Saved", "Successfully");
              }
  
              if (result.msg == "notexist") {
                warning("Not Exist", `${companymodal} Does not exist!`);
              }
            },
            error: function (err) {
              errormsg(err);
            },
          });
        }
      });
  
      //Status Update
      $(document).on("click", "#activeBtn", function () {
        console.log(id);
        console.log(status);
        $.ajax({
          type: "POST",
          url: "/client/status",
          data: {
            status: status,
            id: id,
          },
          success: function (result) {
            if (result.msg == "success") {
              LoadTable();
              success("Saved", "Successfully");
            }
  
            if (result.msg == "notexist") {
              warning(`${id} does not exist!`);
            }
          },
          error: function (err) {
            errormsg(err);
          },
        });
      });
  
      $(document).on("click", "#inactiveBtn", function () {
        console.log(id);
        console.log(status);
        $.ajax({
          type: "POST",
          url: "/client/status",
          data: {
            status: status,
            id: id,
          },
          success: function (result) {
            if (result.msg == "success") {
              LoadTable();
              success("Saved", "Successfully");
            }
  
            if (result.msg == "notexist") {
              warning(`${id} does not exist!`);
            }
          },
          error: function (err) {
            errormsg(err);
          },
        });
      });
  
      $("#search").on("keyup", function () {
        var input, filter, table, tr, td, i, txtValue;
        input = document.getElementById("search");
        filter = input.value.toUpperCase();
        table = document.getElementById("datatable");
        tr = table.getElementsByTagName("tr");
        for (i = 0; i < tr.length; i++) {
          td = tr[i].getElementsByTagName("td")[1];
          if (td) {
            txtValue = td.textContent || td.innerText;
            if (txtValue.toUpperCase().indexOf(filter) > -1) {
              tr[i].style.display = "";
            } else {
              tr[i].style.display = "none";
            }
          }
        }
      });
  
      function populatedatatable(data) {
        console.log(data);
        const tableBody = $('#datatable tbody');
        tableBody.empty();
  
        if (data.length === 0) {
            const tr = $('<tr>').append($('<td>', {
                colspan: 7,
                class: 'text-center',
                text: 'No Data Matched'
            }));
            tableBody.append(tr);
        } else {
            data.forEach(item => {
                let action = '';
                if (item.status === 'ACTIVE') {
                    action = `
                        <span class="editbutton" id="editBtn" name="editBtn" data-toggle="modal" data-target="#editModal"><i class="fas fa-edit" style="color: #45edf2;"></i></span>
                        <span class="editbutton" id="inactiveBtn"><i class="fas fa-eye-slash" style="color: #45edf2;"></i></span>`;
                } else if (item.status === 'INACTIVE') {
                    action = `
                        <span class="editbutton" id="editBtn" name="editBtn" data-toggle="modal" data-target="#editModal"><i class="fas fa-edit" style="color: #45edf2;"></i></span>
                        <span class="editbutton" id="activeBtn"><i class="fas fa-eye" style="color: #45edf2;"></i></span>`;
                }
  
                const tr = $('<tr>').append(
                    $('<td>', { text: item.id, 'data-label': 'ID', class: 'custom-mobile-align' }),
                    $('<td>', { text: item.company, 'data-label': 'Company', class: 'custom-mobile-align' }),
                    $('<td>', { text: item.branch, 'data-label': 'Branch', class: 'custom-mobile-align' }),
                    $('<td>', { text: item.status, 'data-label': 'Status', class: 'custom-mobile-align' }),
                    $('<td>', { text: item.createdby, 'data-label': 'Created By', class: 'custom-mobile-align' }),
                    $('<td>', { text: item.createddate, 'data-label': 'Created Date', class: 'custom-mobile-align' }),
                    $('<td>', { html: action, 'data-label': 'Action', class: 'actionWidth' })
                );
  
                tableBody.append(tr);
            });
        }
      }
      
      function LoadTable() {
        $(".progress").hide();
        $(".progress").slideDown();
  
        $.ajax({
            url: '/client/load',
            method: 'GET',
            dataType: 'json',
            xhrFields: {
                onprogress: function (e) {
                    if (e.lengthComputable) {
                        var percentComplete = (e.loaded / e.total) * 100;
                        $(".progress-bar").css("width", percentComplete + "%");
                    }
                }
            },
            success: function (data) {
                setTimeout(function () {
                    $(".progress").slideUp(function () {
                        if (data.msg === 'success') {
                            populatedatatable(data.data);
                        } else {
                            console.error(data.msg);
                        }
                    });
                }, 1000);
            },
            error: function (error) {
                console.error(error);
            }
        });
      }
    });

    $(document).on('click', '#companyDropdown .dropdown-option', function() {
      let companyname = $(this).text();
      $('#companyname').val(companyname).trigger('change');
      activeBranch.length = 0;
      $('#branchDropdown .dropdown-option').remove();
      $("#branchname").val('');

      $.ajax({
        type: "POST",
        url: "/client/getbranch",
        data: {
          company: companyname,
        },
        success: function (result) {
          let container = result.data;

          $.each(container, (key, item) => {
            activeBranch.push(item.branch); 
          });

          console.log("branches: ", activeBranch)
          populateCustomDropdown();
          
          function populateCustomDropdown() {
              for (const branch of activeBranch) {
                  addOption("branchDropdown", branch);
              }
          }

          function addOption(dropdownId, optionText) {
              const dropdownElement = document.getElementById(dropdownId);
              const newOption = document.createElement("div");
              newOption.className = "dropdown-option";
              newOption.textContent = optionText;

              newOption.addEventListener("click", function () {
                  const inputElement = document.getElementById("branchname");
                  inputElement.value = optionText;
                  dropdownElement.style.display = "none";
              });
              
              dropdownElement.appendChild(newOption);
          }
          
          setupCustomDropdown("branchname", "branchDropdown", "dropdown-option");
        },
        error: function (err) {
          errormsg(err);
        },
      });
    });

    let activeBranch = [];
    let activeCompany = [];

    function LoadList() {
      $.ajax({
        type: "GET",
        url: "/client/getcompany",
        success: function (result) {
            let container = result.data;
            console.log(container);
            $.each(container, (key, item) => {
                if (activeCompany.indexOf(item.company) === -1) {
                    activeCompany.push(item.company); 
                }
            });
            populateCustomDropdown1();
        },
        error: function (err) {
            errormsg(err);
        },
      });
    }


    function populateCustomDropdown1() {
        for (const company of activeCompany) {
            addOption2("companyDropdown", company);
        }
    }

    function setupCustomDropdown(inputId, dropdownId, optionClass) {
        const inputElement = document.getElementById(inputId);
        const dropdownElement = document.getElementById(dropdownId);
        const options = dropdownElement.getElementsByClassName(optionClass);

        inputElement.addEventListener("click", function () {
            dropdownElement.style.display = "block";
        });

        for (const option of options) {
            option.addEventListener("click", function () {
                inputElement.value = option.textContent;
                dropdownElement.style.display = "none";
            });
        }

        inputElement.addEventListener("input", function () {
            const value = inputElement.value.toUpperCase();
            for (const option of options) {
                if (option.textContent.toUpperCase().includes(value)) {
                    option.style.display = "block";
                } else {
                    option.style.display = "none";
                }
            }
            dropdownElement.style.display = "block";
        });

        document.addEventListener("click", function (event) {
            const target = event.target;
            if (!dropdownElement.contains(target) && target !== inputElement) {
                dropdownElement.style.display = "none";
            }
        });
    }

    function addOption2(dropdownId, optionText) {
        const dropdownElement = document.getElementById(dropdownId);
        const newOption = document.createElement("div");
        newOption.className = "dropdown-option";
        newOption.textContent = optionText;

        newOption.addEventListener("click", function () {
            const inputElement = document.getElementById("companyname");
            inputElement.value = optionText;
            dropdownElement.style.display = "none";
        });
        
        dropdownElement.appendChild(newOption);
    }

    setupCustomDropdown("companyname", "companyDropdown", "dropdown-option");
    LoadList()
  </script>
  